<!-- producerApp v0 -->
<html>
  <head>
    <title>Producer Gems</title>
    <link rel="stylesheet" href="css/timeline.css" media="screen" title="no title" charset="utf-8">
    <script src="js/classnames.js"></script>
    <script src="https://fb.me/react-0.13.3.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  </head>
  <body>
    <div id="content" class="container">
    </div>
    <script type="text/jsx">

    var TimeLineContainer = React.createClass({
      getInitialState : function () {
            return {data : []}
      },

      componentDidMount : function () {
        $.ajax({
          url: '/api/song/54779ed6e5bb055c15b0227d',
          dataType: 'json',
          cache: false,
          success: function (data) {
            var annotations = data.annotations
            this.setState({data: annotations});
          }.bind(this),

          error: function(xhr, status, err) {
            console.error('URL', status, err.toString());
          }.bind(this)
        });
      },
      render : function () {
        return (
          <div className="timeline">
            <AnnotationForm handleAnnotationSubmit={this.handleAnnotationSubmit} />
            <TimeLine data={this.state.data} handleAnnotationDeletion={this.handleAnnotationDeletion}/>
          </div>
        )
      },

      handleAnnotationSubmit : function (annotation) {
        // Submit the annotation to the server and refresh the list of annotations.
        $.ajax({
            url : '/api/annotation/54779ed6e5bb055c15b0227d', // Do not hardcode this in the future
            dataType : 'json',
            type : 'POST',
            data : annotation,
            success : function (data) {
              var annotations = data.annotations
              this.setState({data : annotations})
            }.bind(this),
            error : function (xhr, status, err) {
              console.err('Error while creating annotation', status, err);
            }
        });
      },
      handleAnnotationDeletion : function (annotationId) {
        $.ajax({
          url : '/api/annotation/54779ed6e5bb055c15b0227d', // Do not hardcode this in the future
          dataType : 'json',
          type : 'DELETE',
          data : {id : annotationId},
          success : function (data) {
            var annotations = data.annotations;
            this.setState({data : annotations})
          }.bind(this),
          error : function (xhr, status, err) {
            console.err('Error while deleting annotation', status,err);
          }
        })
      }
    });

      var TimeLine = React.createClass({
        render : function () {
          var handleAnnotationDeletion = this.props.handleAnnotationDeletion;
          var annotationRowNodes = this.props.data.map(function (annotation) {
            return(
              <div className="row">
                <Annotation type={annotation.type} start={annotation.start} stop={annotation.stop} upvotes={annotation.upvotes} description={annotation.description} server_id={annotation._id} handleAnnotationDeletion={handleAnnotationDeletion}/>
              </div>
            )
          });

            return (
              <div>
              {annotationRowNodes}
              </div>
            )
        }
      });

      var Annotation = React.createClass({
        getInitialState : function () {
          return {selected : false, resize : false }
        },
        colorAnnotation : function (type) {
          if (type == "FX") {
            return '#f1c40f'
          }
          else if (type == "Sample"){
            return '#1abc9c'
          }
          else if (type == "Synth"){
            return '#8e44ad'
          }
        },
        render : function () {
          var cx = classNames;
          var classes = cx({
            'annotation' : true,
            'selected' : this.state.selected,
          })

          var buttonClasses = cx({
            'delete-button' : this.state.selected
          })

          var handleClasses = cx({
            'handle' : this.state.selected
          })

          return (
            <div onMouseMove={this.handleResize} onDoubleClick={this.handleSelect} style={{position : 'absolute', left : this.props.start +'%', width : (this.props.stop - this.props.start)+'%'}}>
              <span className={classes} style={{backgroundColor : this.colorAnnotation(this.props.type)}}></span>
              <a className={handleClasses} onMouseUp={this.handleMouseUp} onMouseDown={this.handleMouseDown} style={{cursor : 'w-resize', position : 'absolute', left : '0%', backgroundColor : this.colorAnnotation(this.props.type)}}></a>
              <a className={handleClasses} style={{cursor : 'e-resize', position : 'absolute', left : '100%', backgroundColor : this.colorAnnotation(this.props.type)}}></a>
            </div>
          )
        },
        handleSelect : function (e) {
          e.preventDefault();
          var annotationId = this.props.server_id

          if (this.state.selected) {
            this.setState({selected : false})
          } else {
            this.setState({selected : true})
          }
          //this.props.handleAnnotationDeletion(annotationId)
        },
        handleDeleteClick : function (e) {
          e.preventDefault();
          console.log("About to delete ");
          var annotationId = this.props.server_id;
          this.props.handleAnnotationDeletion(annotationId);
        },
        handleMouseDown : function (e) {
          e.preventDefault();
          this.setState({resize : true})
        },
        handleMouseUp : function (e) {
          e.preventDefault();
          this.setState({resize : false})
        },
        handleResize : function (e) {
          if (this.state.resize){
              console.log("Resizing");
          }
        }
      });

      var AnnotationForm = React.createClass({
        render : function () {
          return (

              <form onSubmit={this.handleSubmit}>
                <input type="text" placeholder="start" ref="start"/>
                <input type="text" placeholder="stop" ref="stop"/>
                <select ref="type">
                  <option>FX</option>
                  <option>Sample</option>
                  <option>Synth</option>

                </select>
                <input type="text" ref="description" placeholder="Description"/>
                <input type="submit" value="Add"/>

              </form>

            )
        },

        handleSubmit : function (e) {
          e.preventDefault();

          var annotation = {
            start : React.findDOMNode(this.refs.start).value.trim(),
            stop : React.findDOMNode(this.refs.stop).value.trim(),
            description : React.findDOMNode(this.refs.description).value.trim(),
            type : React.findDOMNode(this.refs.type).value.trim()

          }

          this.props.handleAnnotationSubmit(annotation);
          this.clearForm(); // Clears the form upon succesful submission of the annotation
          return;
        },

        clearForm : function () {
          React.findDOMNode(this.refs.start).value = '';
          React.findDOMNode(this.refs.stop).value = '';
          React.findDOMNode(this.refs.description).value = '';

        }
      });

      React.render(
        <TimeLineContainer />, document.getElementById('content')
      )
    </script>
  </body>
</html>
